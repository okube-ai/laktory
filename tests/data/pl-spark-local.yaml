name: pl-stock-prices
nodes:
- name: brz_stock_prices
  layer: BRONZE
  source:
    format: PARQUET
    path: ./data/brz_stock_prices/

- name: slv_stock_prices
  layer: SILVER
  source:
    node_name: brz_stock_prices
  sink:
    format: PARQUET
    mode: OVERWRITE
    path: ../tmp/pl_slv_sink
  chain:
    nodes:
    - column:
        name: created_at
        type: timestamp
      sql_expression: data.created_at
    - column:
        name: symbol
      spark_func_name: coalesce
      spark_func_args:
      - value: data.symbol
    - column:
        name: close
        type: double
      sql_expression: data.close
    - spark_func_name: drop
      spark_func_args:
      - value: data
      - value: producer
      - value: name
      - value: description
    - spark_func_name: smart_join
      spark_func_kwargs:
        'on':
          - symbol
        other:
          node_name: slv_stock_meta
          renames:
            symbol2: symbol

- name: gld_max_stock_prices
  layer: GOLD
  source:
    node_name: slv_stock_prices
  sink:
    format: PARQUET
    mode: OVERWRITE
    path: /tests/tmp/pl_gld_sink
  chain:
    nodes:
    - spark_func_name: groupby_and_agg
      spark_func_kwargs:
        agg_expressions:
        - column:
            name: max_price
            type: double
          spark_func_name: max
          spark_func_args:
          - close
        - column:
            name: min_price
            type: double
          spark_func_name: min
          spark_func_args:
          - close
        groupby_columns:
        - symbol

- name: slv_stock_meta
  layer: SILVER
  source:
    format: PARQUET
    path: ./data/slv_stock_meta
