from datetime import datetime
from zoneinfo import ZoneInfo
import pytest

from laktory._testing import StockPriceDataEventHeader
from laktory._testing import EventsManager
from laktory import models

header = StockPriceDataEventHeader()
events = EventsManager().build_events()
event = events[0]


def test_dataeventheader():
    assert header.model_dump() == {
        "name": "stock_price",
        "description": None,
        "producer": {"name": "yahoo-finance", "description": None, "party": 1},
        "events_root": "/Volumes/dev/sources/landing/events/",
    }
    assert (
        header.event_root
        == "/Volumes/dev/sources/landing/events/yahoo-finance/stock_price/"
    )


def test_dataevent():
    assert event.producer.name == "yahoo-finance"
    assert event.data["symbol"] == "AAPL"
    assert event.data["open"] == pytest.approx(189.49, abs=0.01)
    assert event.data["_producer_name"] == "yahoo-finance"
    assert event.data["_created_at"] == datetime(2023, 9, 1, tzinfo=ZoneInfo("UTC"))
    assert event.created_at == datetime(2023, 9, 1, 0, 0, 0, tzinfo=ZoneInfo("UTC"))
    assert (
        event.get_landing_filepath()
        == "/Volumes/dev/sources/landing/events/yahoo-finance/stock_price/2023/09/01/stock_price_20230901T000000000Z.json"
    )


def test_model_dump():
    # Without exclusions
    d = event.model_dump(exclude=[])
    print(d)
    assert d == {
        "name": "stock_price",
        "description": None,
        "producer": {"name": "yahoo-finance", "description": None, "party": 1},
        "events_root": "/Volumes/dev/sources/landing/events/",
        "data": {
            "created_at": "2023-09-01T00:00:00",
            "symbol": "AAPL",
            "open": 189.49000549316406,
            "close": 189.4600067138672,
            "high": 189.9199981689453,
            "low": 188.27999877929688,
            "@id": "_id",
            "_name": "stock_price",
            "_producer_name": "yahoo-finance",
            "_created_at": "2023-09-01T00:00:00Z",
        },
        "tstamp_col": "created_at",
        "tstamp_in_path": True,
    }

    # With exclusions
    d = event.model_dump()
    print(d)
    assert d == {
        "name": "stock_price",
        "description": None,
        "producer": {"name": "yahoo-finance", "description": None, "party": 1},
        "data": {
            "created_at": "2023-09-01T00:00:00",
            "symbol": "AAPL",
            "open": 189.49000549316406,
            "close": 189.4600067138672,
            "high": 189.9199981689453,
            "low": 188.27999877929688,
            "@id": "_id",
            "_name": "stock_price",
            "_producer_name": "yahoo-finance",
            "_created_at": "2023-09-01T00:00:00Z",
        },
    }


def test_event_without_tstamp():
    d = event.model_dump()
    d["tstamp_in_path"] = False
    e = models.DataEvent(**d)
    assert (
        e.get_landing_filepath()
        == "/Volumes/dev/sources/landing/events/yahoo-finance/stock_price/stock_price.json"
    )


def test_to_azure_storage_container():
    try:
        import azure.storage
    except ModuleNotFoundError:
        return

    event.to_azure_storage_container(container_name="unit-testing", overwrite=True)
    with pytest.raises(FileExistsError):
        event.to_azure_storage_container(container_name="unit-testing")
    event.to_azure_storage_container(container_name="unit-testing", skip_if_exists=True)


def test_to_aws_s3_bucket():
    try:
        import boto3
    except ModuleNotFoundError:
        return

    event.to_aws_s3_bucket(bucket_name="okube-unit-testing", overwrite=True)
    with pytest.raises(FileExistsError):
        event.to_aws_s3_bucket(bucket_name="okube-unit-testing")
    event.to_aws_s3_bucket(bucket_name="okube-unit-testing", skip_if_exists=True)


def test_to_databricks_mount():
    # TODO: add tests
    pass
    # event.to_databricks_mount()


if __name__ == "__main__":
    test_dataeventheader()
    test_dataevent()
    test_model_dump()
    test_event_without_tstamp()
    test_to_azure_storage_container()
    test_to_aws_s3_bucket()
    test_to_databricks_mount()
