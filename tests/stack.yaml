name: unit-testing
config:
  databricks:host: ${var.DATABRICKS_HOST}
  databricks:token: ${var.DATABRICKS_TOKEN}
resources:
  providers:
    databricks-provider:
      host: ${var.DATABRICKS_HOST}
      token: ${var.DATABRICKS_TOKEN}
  pipelines:
    pl-custom-name:
      name: pl-stock-prices-ut-stack
      libraries:
        - notebook:
            path: /pipelines/dlt_brz_template.py
      access_controls:
        - group_name: account users
          permission_level: CAN_VIEW
        - group_name: role-engineers
          permission_level: CAN_RUN
      options:
        provider: ${resources.databricks-provider}
  jobs:
    job-stock-prices-ut-stack:
      name: job-stock-prices-ut-stack
      clusters:
        - name: main
          spark_version: 14.0.x-scala2.12
          node_type_id: ${var.node_type_id}
      tasks:
        - task_key: ingest-metadata
          job_cluster_key: main
          notebook_task:
            notebook_path: /jobs/ingest_stock_metadata.py
          libraries:
            - pypi:
                package: laktory==0.0.27
            - pypi:
                package: yfinance
        - task_key: run-pipeline
          pipeline_task:
            pipeline_id: ${resources.pl-custom-name.id}  # LAKTORY STYLE
#            pipeline_id: ${resources.pipelines.pl-custom-name.id}  # BUNDLES STYLE
#            pipeline_id: ${databricks_pipeline.pl-custom-name.id}  # TERRAFORM STYLE
#            pipeline_id: ${pl-custom-name.id}  # PULUMI STYLE

environments:
  dev:
    variables:
      is_dev: true
      node_type_id: Standard_DS3_v2
  prod:
    resources:
      pipelines:
        pl-custom-name:
          development: False
    variables:
      is_dev: false
      node_type_id: Standard_DS4_v2

