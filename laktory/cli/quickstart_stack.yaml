name: quickstart
backend: terraform
resources:
  databricks_dbfsfiles:
    dbfs-file-stock-prices:
      path: /Workspace/.laktory/landing/events/yahoo-finance/stock_price/stock_prices.json
      source: ./data/stock_prices.json
  databricks_notebooks:
    notebook-pipelines-dlt-template:
      source: ./notebooks/pipelines/dlt_template.py
  pipelines:
    pl-quickstart:
      name: pl-quickstart
      orchestrator: DLT
      dlt:
        development: ${vars.is_dev}
        target: default
        clusters:
        - name: default
          node_type_id: TBD
          autoscale:
            min_workers: 1
            max_workers: 2
        configuration:
          pipeline_name: pl-quickstart
        libraries:
        - notebook:
            path: /.laktory/dlt/dlt_template.py
      nodes:
      - name: brz_stock_prices
        layer: BRONZE
        source:
          path: dbfs:/Workspace/.laktory/landing/events/stock_price
          as_stream: true
          format: JSON
        sink:
          table_name: brz_stock_prices

      - name: slv_stock_prices
        layer: SILVER
        expectations:
        - name: positive_price
          expression: open > 0
          action: FAIL
        source:
          node_name: brz_stock_prices
          as_stream: true
        sink:
          table_name: slv_stock_prices
        transformer:
          nodes:
          - column:
              name: created_at
              type: timestamp
            sql_expression: data.created_at
          - column:
              name: symbol
            spark_func_args:
            - data.symbol
            spark_func_name: coalesce
          - column:
              name: open
              type: double
            sql_expression: data.open
          - column:
              name: close
              type: double
            sql_expression: data.close

  providers:
    databricks:
      host: ${vars.DATABRICKS_HOST}
      token: ${vars.DATABRICKS_TOKEN}
environments:
  dev:
    variables:
      env: dev
      is_dev: true
