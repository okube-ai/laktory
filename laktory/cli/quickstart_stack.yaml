name: quickstart
backend: terraform
resources:
  dbfsfiles:
    dbfs-file-stock-prices:
      path: /Workspace/.laktory/landing/events/yahoo-finance/stock_price/stock_prices.json
      source: ./data/stock_prices.json
  notebooks:
    notebook-pipelines-dlt-brz-template:
      source: ./notebooks/pipelines/dlt_brz_template.py
    notebook-pipelines-dlt-slv-template:
      source: ./notebooks/pipelines/dlt_slv_template.py
  pipelines:
    pl-quickstart:
      name: pl-quickstart
      channel: PREVIEW
      development: ${vars.is_dev}
      target: default
      clusters:
      - name: default
        node_type_id: TBD
        autoscale:
          min_workers: 1
          max_workers: 2
      configuration:
        pipeline_name: pl-quickstart
      libraries:
      - notebook:
          path: /.laktory/pipelines/dlt_brz_template.py
      - notebook:
          path: /.laktory/pipelines/dlt_slv_template.py
      tables:
      - name: brz_stock_prices
        builder:
          layer: BRONZE
          event_source:
            name: stock_price
            producer:
              name: yahoo-finance
              party: 1
            events_root_: dbfs:/Workspace/.laktory/landing/events/
            read_as_stream: true
            fmt: JSON
      - name: slv_stock_prices
        expectations:
        - name: positive_price
          expression: open > 0
          action: FAIL
        builder:
          layer: SILVER
          table_source:
            read_as_stream: true
            name: brz_stock_prices
          spark_chain:
            nodes:
            - column:
                name: created_at
                type: timestamp
              sql_expression: data.created_at
            - column:
                name: symbol
              spark_func_args:
              - data.symbol
              spark_func_name: coalesce
            - column:
                name: open
                type: double
              sql_expression: data.open
            - column:
                name: close
                type: double
              sql_expression: data.close

  providers:
    databricks:
      host: ${vars.DATABRICKS_HOST}
      token: ${vars.DATABRICKS_TOKEN}
environments:
  dev:
    variables:
      env: dev
      is_dev: true
